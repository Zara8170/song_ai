name: CI/CD for AI Server

on:
  push:
    branches: ["main"]
  workflow_dispatch:

env:
  IMAGE_NAME: ${{ secrets.AI_DOCKER_IMAGE_NAME }}

jobs:
  build-and-push-ai:
    name: Build and Push AI Server Image
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Authenticate to Google Cloud
        id: auth
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SERVICE_ACCOUNT_KEY }}

      - name: Extract REGISTRY_HOST
        run: |
          REGISTRY_HOST="$(echo '${{ env.IMAGE_NAME }}' | cut -d'/' -f1)"
          echo "REGISTRY_HOST=$REGISTRY_HOST" >> "$GITHUB_ENV"

      - name: Check registry reachability (optional)
        run: |
          nslookup "$REGISTRY_HOST" || true
          curl -I --max-time 10 "https://$REGISTRY_HOST/v2/" || true

      - name: Docker login with access token (robust)
        run: |
          gcloud auth print-access-token | docker login -u oauth2accesstoken --password-stdin "https://$REGISTRY_HOST"

      - name: Build image
        run: |
          docker build -t "${{ env.IMAGE_NAME }}:latest" .

      - name: Push image with retries (reduced parallelism)
        env:
          DOCKER_CLIENT_TIMEOUT: "600"
          COMPOSE_HTTP_TIMEOUT: "600"
        run: |
          mkdir -p ~/.docker
          if [ -f ~/.docker/config.json ]; then
            jq '. + {"maxConcurrentUploads": 1, "experimental": "enabled"}' ~/.docker/config.json > ~/.docker/config.json.tmp || true
            mv ~/.docker/config.json.tmp ~/.docker/config.json || true
          else
            echo '{"maxConcurrentUploads": 1, "experimental": "enabled"}' > ~/.docker/config.json
          fi

          n=0
          until [ $n -ge 5 ]; do
            docker push "${{ env.IMAGE_NAME }}:latest" && exit 0
            n=$((n+1))
            echo "push failed. retry $n/5..."
            sleep $((5*n))
          done
          echo "push failed after retries" >&2
          exit 1

  deploy-ai:
    name: Deploy AI Server to GCP VM
    needs: build-and-push-ai
    runs-on: ubuntu-latest

    steps:
      - name: Test SSH port from runner (optional)
        run: nc -vz ${{ secrets.GCP_VM_HOST }} 22

      - name: SSH and Deploy to VM
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.GCP_VM_HOST }}
          username: ${{ secrets.GCP_VM_USER }}
          key: ${{ secrets.GCP_VM_SSH_PRIVATE_KEY }}
          script: |
            set -euo pipefail

            IMAGE_NAME='${{ secrets.AI_DOCKER_IMAGE_NAME }}'
            REGISTRY_HOST="$(echo "$IMAGE_NAME" | cut -d'/' -f1)"

            has_cmd() { command -v "$1" >/dev/null 2>&1; }

            # --- Artifact Registry pull auth ---
            if [ -n "${{ secrets.AR_PULL_KEY_JSON_B64 || '' }}" ]; then
              echo "${{ secrets.AR_PULL_KEY_JSON_B64 }}" | base64 -d > /tmp/ar_key.json
              docker login -u _json_key --password-stdin "https://$REGISTRY_HOST" < /tmp/ar_key.json
              rm -f /tmp/ar_key.json
            else
              if has_cmd gcloud; then
                gcloud auth configure-docker "$REGISTRY_HOST" -q || true
              fi
            fi

            export AI_DOCKER_IMAGE_NAME="$IMAGE_NAME"

            # --- App dir & code sync ---
            cd ~/song_ai || { mkdir -p ~/song_ai; cd ~/song_ai; }
            if has_cmd git; then
              [ -d .git ] && git pull origin main || true
            fi

            # --- Pull the latest image (best-effort) ---
            docker pull "${AI_DOCKER_IMAGE_NAME}:latest" || true

            # --- Cleanly restart with compose ---
            if docker compose version >/dev/null 2>&1; then
              COMPOSE="docker compose"
            elif has_cmd docker-compose; then
              COMPOSE="docker-compose"
            else
              echo "docker compose/docker-compose not found" >&2
              exit 1
            fi

            $COMPOSE down --remove-orphans || true
            $COMPOSE pull || true
            $COMPOSE up -d --force-recreate --remove-orphans

            docker image prune -f || true
